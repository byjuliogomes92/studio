rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isMember(workspaceId) {
      return exists(/databases/$(database)/documents/workspaceMembers/$(request.auth.uid)_$(workspaceId));
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- Collections ---
    match /workspaces/{workspaceId} {
      allow read: if isMember(workspaceId);
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isMember(workspaceId); // More specific roles can be added later
    }

    match /workspaceMembers/{membershipId} {
      allow read: if request.auth.uid == resource.data.userId;
      // Allow only the workspace owner to add/remove members
      allow write: if get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid;
    }

    match /projects/{projectId} {
      // Allow read if user is a member of the workspace OR if they are the owner of old data (for migration)
      allow read: if isMember(resource.data.workspaceId) || isOwner(resource.data.userId);
      allow write: if isMember(request.resource.data.workspaceId);
    }
    
    match /brands/{brandId} {
      allow read: if isMember(resource.data.workspaceId) || isOwner(resource.data.userId);
      allow write: if isMember(request.resource.data.workspaceId);
    }

    match /pages_drafts/{pageId} {
      allow read: if isMember(resource.data.workspaceId) || isOwner(resource.data.userId);
      allow write: if isMember(request.resource.data.workspaceId);
    }

    match /pages_published/{pageId} {
      // Publicly readable for the live page
      allow read: if true;
      // Writable only by workspace members (publishing)
      allow write: if isMember(request.resource.data.workspaceId);
    }

    match /templates/{templateId} {
       // Allow read if template is default, or if user is member of the workspace that owns it, or if it's their old template
      allow read: if resource.data.isDefault == true || isMember(resource.data.workspaceId) || isOwner(resource.data.createdBy);
      allow write: if isMember(request.resource.data.workspaceId);
    }
    
    match /userProgress/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /pageViews/{viewId} {
      allow create: if true;
      // Readable only by members of the workspace that owns the page.
      allow read: if request.auth != null && isMember(get(/databases/$(database)/documents/pages_published/$(resource.data.pageId)).data.workspaceId);
    }

    match /formSubmissions/{submissionId} {
      allow create: if true;
       // Readable only by members of the workspace that owns the page.
      allow read: if request.auth != null && isMember(get(/databases/$(database)/documents/pages_published/$(resource.data.pageId)).data.workspaceId);
    }
  }
}